{% extends "base.html" %}

{% block title %}Device Details - PiSafe{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="topology-header">
            <h1 class="display-5 mb-3">
                <span class="hero-icon">üñ•Ô∏è</span> Device Details
            </h1>
            <p class="lead text-muted">{{ device.ip }}</p>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0">Device Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üåê IP Address:</strong>
                            <span class="ms-2 text-primary">{{ device.ip }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üìü MAC Address:</strong>
                            <code class="ms-2">{{ device.mac or 'N/A' }}</code>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üè∑Ô∏è Hostname:</strong>
                            <span class="ms-2">{{ device.hostname or 'N/A' }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üíª Operating System:</strong>
                            <span class="ms-2">{{ device.os or 'Unknown' }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üîå Open Ports:</strong>
                            <span class="ms-2">{{ device.open_ports or 'None' }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üîç Scan Intensity:</strong>
                            <span class="badge bg-primary ms-2">{{ device.intensity }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üîê Authentication Mode:</strong>
                            <span class="ms-2">{{ device.auth_mode }}</span>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="info-item">
                            <strong>üìÖ Scan Time:</strong>
                            <span class="ms-2">{{ device.scan_time }}</span>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <div class="risk-summary p-3 rounded" style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);">
                            <div class="d-flex align-items-center gap-3">
                                <div>
                                    <strong>Risk Assessment:</strong>
                                </div>
                                <div>
                                    {% if device.risk_level == 'Critical' %}
                                        <span class="badge bg-danger" style="font-size: 1rem;">‚ö†Ô∏è Critical Risk</span>
                                    {% elif device.risk_level == 'High' %}
                                        <span class="badge bg-warning text-dark" style="font-size: 1rem;">‚ö° High Risk</span>
                                    {% elif device.risk_level == 'Moderate' %}
                                        <span class="badge bg-info" style="font-size: 1rem;">üìä Moderate Risk</span>
                                    {% else %}
                                        <span class="badge bg-success" style="font-size: 1rem;">‚úì Low Risk</span>
                                    {% endif %}
                                </div>
                                <div>
                                    <strong>Risk Score:</strong>
                                    <span class="text-primary ms-2" style="font-size: 1.2rem;">{{ "%.2f"|format(device.risk_score) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if device.deep_scan_info %}
        <div class="card mb-4">
            <div class="card-header-modern">
                <h5 class="mb-0">üîê Deep Scan Results</h5>
            </div>
            <div class="card-body">
                {% set deep_info = device.deep_scan_info | fromjson %}
                
                {% if deep_info.ssh_results and deep_info.ssh_results.ssh_accessible %}
                <div class="alert alert-warning mb-3">
                    <strong>‚ö†Ô∏è SSH Access Detected!</strong><br>
                    <small>
                        Credentials found: 
                        <code>{{ deep_info.ssh_results.credentials_found.username }}</code> / 
                        <code>{{ '*' * deep_info.ssh_results.credentials_found.password|length }}</code>
                    </small>
                </div>
                
                {% if deep_info.ssh_results.system_info %}
                <div class="mb-3">
                    <strong>System Information:</strong>
                    <pre class="mt-2 p-3" style="background: rgba(0, 255, 65, 0.05); border: 1px solid var(--cyber-green); border-radius: 5px; color: var(--cyber-green);"><code>{{ deep_info.ssh_results.system_info }}</code></pre>
                </div>
                {% endif %}
                
                {% if deep_info.ssh_results.firmware_info %}
                <div class="mb-3">
                    <strong>Firmware/Version:</strong>
                    <pre class="mt-2 p-3" style="background: rgba(0, 255, 65, 0.05); border: 1px solid var(--cyber-green); border-radius: 5px; color: var(--cyber-green);"><code>{{ deep_info.ssh_results.firmware_info }}</code></pre>
                </div>
                {% endif %}
                {% else %}
                <div class="alert alert-info">
                    <strong>‚ÑπÔ∏è No SSH access</strong> - Device does not accept common credentials.
                </div>
                {% endif %}
                
                {% if deep_info.http_results and deep_info.http_results.http_accessible %}
                <div class="mb-3">
                    <strong>HTTP Server Information:</strong>
                    <ul class="mt-2">
                        <li>Status Code: <span class="badge bg-success">{{ deep_info.http_results.status_code }}</span></li>
                        {% if deep_info.http_results.server_header %}
                        <li>Server: <code>{{ deep_info.http_results.server_header }}</code></li>
                        {% endif %}
                        {% if deep_info.http_results.page_title %}
                        <li>Page Title: {{ deep_info.http_results.page_title }}</li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <div class="card">
            <div class="card-header-modern">
                <h5 class="mb-0">üõ°Ô∏è Vulnerabilities (CVEs)</h5>
            </div>
            <div class="card-body">
                {% if vulnerabilities %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>CVE ID</th>
                                <th>Description</th>
                                <th>Severity</th>
                                <th>CVSS Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vuln in vulnerabilities %}
                            <tr>
                                <td>
                                    <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.cve_id }}" target="_blank" class="text-decoration-none">
                                        <strong>{{ vuln.cve_id }}</strong> üîó
                                    </a>
                                </td>
                                <td>{{ vuln.description }}</td>
                                <td>
                                    {% if vuln.severity == 'CRITICAL' %}
                                        <span class="badge bg-danger">Critical</span>
                                    {% elif vuln.severity == 'HIGH' %}
                                        <span class="badge bg-warning text-dark">High</span>
                                    {% elif vuln.severity == 'MEDIUM' %}
                                        <span class="badge bg-info">Medium</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ vuln.severity }}</span>
                                    {% endif %}
                                </td>
                                <td><strong>{{ "%.1f"|format(vuln.score) }}</strong></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success">
                    <strong>‚úì No vulnerabilities found</strong> for this device.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="mt-3">
            <a href="/reports" class="btn btn-secondary">‚Üê Back to Reports</a>
            <a href="/topology" class="btn btn-primary">üó∫Ô∏è View in Topology</a>
        </div>
    </div>
</div>
{% endblock %}
